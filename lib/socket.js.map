{"version":3,"sources":["../src/socket.js"],"names":["JSONSocket","constructor","options","packetId","stats","in","out","callbackLookup","maxAgeSec","url","onOpen","onClose","autoreconnect","autoconnect","connectWait","initSocket","ws","WebSocket","onopen","bind","onclose","onmessage","e","onMessage","JSON","parse","data","setTimeout","open","packet","eventNameToFunction","d","id","fn","get","callbackKey","endsWith","toString","send","eventType","isConnected","stringify","Promise","resolve","reject","add","addEvent","fnName","toLowerCase","currentFn","apply","arguments","openState","OPEN","readyState","close","window"],"mappings":"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","file":"socket.js","sourcesContent":["// @flow\n\nimport TimedHash from './timed_hash'\n\ntype Packet = {\n\te:string,\n\td:Object,\n\tid?:number\n}\n\nexport default class JSONSocket {\n\tws:WebSocket;\n\toptions:Object;\n\tpacketId:number;\n\tcallbackLookup:TimedHash;\n\tstats:{in:number,out:number};\n\t\n\tconstructor(options:Object) {\n\n\t\tthis.packetId = 1;\n\t\tthis.stats = { in: 0, out: 0 };\n\t\tthis.callbackLookup = new TimedHash({ maxAgeSec: 30.0 });\n\n\t\tthis.options = options || {};\n\t\tthis.options.url = this.options.url || null;\n\t\tthis.options.onOpen = this.options.onOpen || function() {};\n\t\tthis.options.onClose = this.options.onClose || function() {};\n\n\t\tthis.options.autoreconnect = this.options.autoreconnect === false ? false : true;\n\t\tthis.options.autoconnect = this.options.autoconnect === false ? false : true;\n\t\tthis.options.connectWait = 1;\n\n\t\tif(this.options.autoconnect) {\n\t\t\tthis.initSocket();\n\t\t}\n\t}\n\n\tinitSocket() {\n\t\tthis.ws = new WebSocket(this.options.url);\n\t\tthis.ws.onopen = this.onOpen.bind(this);\n\t\tthis.ws.onclose = this.onClose.bind(this);\n\t\tthis.ws.onmessage = function(e) {\n\t\t\t// $FlowFixMe\n\t\t\tthis.onMessage(JSON.parse(e.data));\n\t\t}.bind(this);\n\t}\n\t\n\tonOpen() {\n\t\tthis.options.connectWait = 1.0;\n\t\tthis.options.onOpen(this, this.ws);\n\t}\n\t\n\tonClose() {\n\t\tthis.options.onClose(this, this.ws);\n\n\t\tif(this.options.autoreconnect === true) {\n\t\t\tsetTimeout(() => this.open(), this.options.connectWait * 1000);\n\t\t\tthis.options.connectWait *= 2;\n\t\t\tthis.options.connectWait = this.options.connectWait > 30 ? 30 : this.options.connectWait;\n\t\t}\n\t}\n\t\n\tonMessage(packet:Packet) {\n\t\tif(packet.e && typeof packet.e == 'string') {\n\t\t\tthis.stats.in++;\n\t\t\t(this.eventNameToFunction(packet.e))(packet.d);\n\n\t\t\tif(packet.id) {\n\t\t\t\tvar fn = this.callbackLookup.get(this.callbackKey(packet));\n\t\t\t\tif(fn) {\n\t\t\t\t\tfn(packet.d);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tcallbackKey(packet:Packet) {\n\t\tif(packet.e.endsWith(\":reply\")) {\n\t\t\treturn `${packet.e}:${(packet.id || 0).toString()}`;\n\t\t} else {\n\t\t\treturn `${packet.e}:reply:${(packet.id || 0).toString()}`;\n\t\t}\n\t}\n\n\tsend(eventType:string, data:Object) {\n\t\tif(this.isConnected()) {\n\t\t\tthis.packetId += 1;\n\t\t\tvar packet:Packet = {e: eventType, d: data, id: this.packetId}\n\t\t\tthis.ws.send(JSON.stringify(packet));\n\t\t\tthis.stats.out++;\n\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tthis.callbackLookup.add(this.callbackKey(packet), resolve);\n\t\t\t});\n\t\t\t\n\t\t} else {\n\t\t\treturn Promise.reject('NOT_CONNECTED');\n\t\t}\n\t}\n\n\taddEvent(eventType:string, fn:Function) {\n\t\t\n\t\tif(eventType && typeof fn == 'function') {\n\t\t\tvar fnName = 'on_' + eventType.toLowerCase();\n\t\t\t\n\t\t\tif(!this.options[fnName]) {\n\t\t\t\tthis.options[fnName] = fn;\n\t\t\t} else if(typeof this.options[fnName] == 'function') {\n\t\t\t\tvar currentFn = this.options[fnName];\n\t\t\t\tthis.options[fnName] = function() {\n\t\t\t\t\tcurrentFn.apply(this, arguments);\n\t\t\t\t\tfn.apply(this, arguments);\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\treturn this;\n\t}\n\n\teventNameToFunction(eventType:string):Function {\n\t\tif(eventType) {\n\t\t\tvar fnName = 'on_' + eventType.toLowerCase();\n\t\t\treturn this.options[fnName] || (()=>{});\n\t\t} else {\n\t\t\treturn (()=>{});\n\t\t}\n\t}\n\n\tisConnected() {\n\t\tvar openState = WebSocket.OPEN || 1; // turns out not all browsers define the state consts\n\t\treturn this.ws && this.ws.readyState === openState;\n\t}\n\n\tclose() {\n\t\tthis.options.autoreconnect = false;\n\t\tthis.ws.close();\n\t}\n\n\topen() {\n\t\tthis.initSocket();\n\t}\n}\n\n// global export...\nwindow.JSONSocket = window.JSONSocket  || JSONSocket;\n"]}