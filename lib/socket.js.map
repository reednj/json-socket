{"version":3,"sources":["../src/socket.js"],"names":["JSONSocket","constructor","options","packetId","stats","in","out","callbackLookup","TimedHash","maxAgeSec","url","onOpen","onClose","autoreconnect","autoconnect","connectWait","startsWith","document","location","protocol","hostname","port","initSocket","ws","WebSocket","onclose","bind","onmessage","e","onMessage","JSON","parse","data","_whenConnected","Promise","resolve","reject","onopen","setTimeout","open","packet","eventNameToFunction","d","id","fn","get","callbackKey","endsWith","toString","send","eventType","isConnected","stringify","add","addEvent","fnName","toLowerCase","currentFn","apply","arguments","openState","OPEN","readyState","close","whenConnected","lastPurge","Date","now","k","contents","purge","addedAt","contains","expiredKeys","forEach","count","Object","keys","length","filter"],"mappings":"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","file":"socket.js","sourcesContent":["// @flow\n\nexport type Packet = {\n\te:string,\n\td:Object,\n\tid?:number\n}\n\nexport class JSONSocket {\n\tws:WebSocket;\n\toptions:Object;\n\tpacketId:number;\n\tcallbackLookup:TimedHash;\n\tstats:{in:number,out:number};\n\t_whenConnected:Promise<*>;\t\n\tconstructor(options:Object) {\n\n\t\tthis.packetId = 1;\n\t\tthis.stats = { in: 0, out: 0 };\n\t\tthis.callbackLookup = new TimedHash({ maxAgeSec: 30.0 });\n\n\t\tthis.options = options || {};\n\t\tthis.options.url = this.options.url || '';\n\t\tthis.options.onOpen = this.options.onOpen || function() {};\n\t\tthis.options.onClose = this.options.onClose || function() {};\n\n\t\tthis.options.autoreconnect = this.options.autoreconnect === false ? false : true;\n\t\tthis.options.autoconnect = this.options.autoconnect === false ? false : true;\n\t\tthis.options.connectWait = 1;\n\n\t\tif(!this.options.url.startsWith('ws://') && !this.options.url.startsWith('wss://')) {\n\t\t\tif(document.location.protocol == 'https') {\n\t\t\t\tthis.options.url = `wss://${document.location.hostname}` + this.options.url\n\t\t\t} else {\n\t\t\t\tthis.options.url = `ws://${document.location.hostname}:${document.location.port || '80'}` + this.options.url;\n\t\t\t}\n\t\t}\n\n\t\tif(this.options.autoconnect) {\n\t\t\tthis.initSocket();\n\t\t}\n\t}\n\n\tinitSocket() {\n\t\tthis.ws = new WebSocket(this.options.url);\n\t\tthis.ws.onclose = this.onClose.bind(this);\n\t\tthis.ws.onmessage = function (e) {\n\t\t\t// $FlowFixMe\n\t\t\tthis.onMessage(JSON.parse(e.data));\n\t\t}.bind(this);\n\n\t\tthis._whenConnected = new Promise((resolve, reject) => {\n\t\t\tthis.ws.onopen = () => {\n\t\t\t\tthis.onOpen();\n\t\t\t\tresolve(this);\n\t\t\t}\n\t\t});\n\t}\n\t\n\tonOpen() {\n\t\tthis.options.connectWait = 1.0;\n\t\tthis.options.onOpen(this, this.ws);\n\t}\n\t\n\tonClose() {\n\t\tthis.options.onClose(this, this.ws);\n\n\t\tif(this.options.autoreconnect === true) {\n\t\t\tsetTimeout(() => this.open(), this.options.connectWait * 1000);\n\t\t\tthis.options.connectWait *= 2;\n\t\t\tthis.options.connectWait = this.options.connectWait > 30 ? 30 : this.options.connectWait;\n\t\t}\n\t}\n\t\n\tonMessage(packet:Packet) {\n\t\tif(packet.e && typeof packet.e == 'string') {\n\t\t\tthis.stats.in++;\n\t\t\t(this.eventNameToFunction(packet.e))(packet.d);\n\n\t\t\tif(packet.id) {\n\t\t\t\tvar fn = this.callbackLookup.get(this.callbackKey(packet));\n\t\t\t\tif(fn) {\n\t\t\t\t\tfn(packet.d);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tcallbackKey(packet:Packet) {\n\t\tif(packet.e.endsWith(\":reply\")) {\n\t\t\treturn `${packet.e}:${(packet.id || 0).toString()}`;\n\t\t} else {\n\t\t\treturn `${packet.e}:reply:${(packet.id || 0).toString()}`;\n\t\t}\n\t}\n\n\tsend(eventType:string, data:any) {\n\t\tif(this.isConnected()) {\n\t\t\tthis.packetId += 1;\n\t\t\tvar packet:Packet = {e: eventType, d: data, id: this.packetId}\n\t\t\tthis.ws.send(JSON.stringify(packet));\n\t\t\tthis.stats.out++;\n\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tthis.callbackLookup.add(this.callbackKey(packet), resolve);\n\t\t\t});\n\t\t\t\n\t\t} else {\n\t\t\treturn Promise.reject('NOT_CONNECTED');\n\t\t}\n\t}\n\n\taddEvent(eventType:string, fn:Function) {\n\t\t\n\t\tif(eventType && typeof fn == 'function') {\n\t\t\tvar fnName = 'on_' + eventType.toLowerCase();\n\t\t\t\n\t\t\tif(!this.options[fnName]) {\n\t\t\t\tthis.options[fnName] = fn;\n\t\t\t} else if(typeof this.options[fnName] == 'function') {\n\t\t\t\tvar currentFn = this.options[fnName];\n\t\t\t\tthis.options[fnName] = function() {\n\t\t\t\t\tcurrentFn.apply(this, arguments);\n\t\t\t\t\tfn.apply(this, arguments);\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\treturn this;\n\t}\n\n\teventNameToFunction(eventType:string):Function {\n\t\tif(eventType) {\n\t\t\tvar fnName = 'on_' + eventType.toLowerCase();\n\t\t\treturn this.options[fnName] || (()=>{});\n\t\t} else {\n\t\t\treturn (()=>{});\n\t\t}\n\t}\n\n\tisConnected() {\n\t\tvar openState = WebSocket.OPEN || 1; // turns out not all browsers define the state consts\n\t\treturn this.ws && this.ws.readyState === openState;\n\t}\n\n\tclose() {\n\t\tthis.options.autoreconnect = false;\n\t\tthis.ws.close();\n\t}\n\n\topen() {\n\t\tthis.initSocket();\n\t}\n\n\twhenConnected() {\n\t\treturn this._whenConnected;\n\t}\n}\n\nclass TimedHash {\n\tlastPurge:number;\n\tdata:{};\n\toptions:{ maxAgeSec:number };\n\n\tconstructor(options:Object) {\n\t\tthis.options = options || {};\n\t\tthis.options.maxAgeSec = this.options.maxAgeSec || 30.0;\n\t\tthis.data = {};\n\t\tthis.lastPurge = Date.now();\n\t}\n\n\tadd(k:string, contents:Object) {\n\t\tif(this.lastPurge < Date.now() - 1000) {\n\t\t\tthis.purge();\n\t\t}\n\n\t\tthis.data[k] = { \n\t\t\tcontents:contents,\n\t\t\taddedAt: Date.now()\n\t\t};\n\t}\n\n\tget(k:string) {\n\t\treturn (this.data[k] || {}).contents;\n\t}\n\n\tcontains(k:string) {\n\t\treturn this.data[k] != null;\n\t}\n\n\tpurge() {\n\t\tthis.expiredKeys().forEach((k) => delete this.data[k]);\n\t\tthis.lastPurge = Date.now();\n\t}\n\n\tcount() {\n\t\treturn Object.keys(this.data).length\n\t}\n\n\texpiredKeys():string[] {\n\t\treturn Object.keys(this.data).filter((k) => {\n\t\t\treturn this.data[k].addedAt < Date.now() - this.options.maxAgeSec * 1000;\n\t\t});\n\t}\n}\n\n"]}