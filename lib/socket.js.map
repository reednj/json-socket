{"version":3,"sources":["../src/socket.js"],"names":["JSONSocket","options","packetId","stats","in","out","callbackLookup","TimedHash","maxAgeSec","url","onOpen","onClose","autoreconnect","autoconnect","connectWait","startsWith","document","location","protocol","hostname","port","initSocket","ws","WebSocket","onclose","bind","onmessage","e","onMessage","JSON","parse","data","_whenConnected","Promise","resolve","reject","onopen","setTimeout","open","packet","eventNameToFunction","d","id","fn","get","callbackKey","endsWith","toString","eventType","isConnected","send","stringify","add","addEvent","fnName","toLowerCase","currentFn","apply","arguments","openState","OPEN","readyState","close","lastPurge","Date","now","k","contents","purge","addedAt","expiredKeys","forEach","Object","keys","length","filter"],"mappings":"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","file":"socket.js","sourcesContent":["// @flow\n\nexport type Packet = {\n\te:string,\n\td:Object,\n\tid?:number\n}\n\nexport class JSONSocket {\n\tws:WebSocket;\n\toptions:Object;\n\tpacketId:number;\n\tcallbackLookup:TimedHash;\n\tstats:{in:number,out:number};\n\t_whenConnected:Promise<*>;\t\n\tconstructor(options:Object) {\n\n\t\tthis.packetId = 1;\n\t\tthis.stats = { in: 0, out: 0 };\n\t\tthis.callbackLookup = new TimedHash({ maxAgeSec: 30.0 });\n\n\t\tthis.options = options || {};\n\t\tthis.options.url = this.options.url || '';\n\t\tthis.options.onOpen = this.options.onOpen || function() {};\n\t\tthis.options.onClose = this.options.onClose || function() {};\n\n\t\tthis.options.autoreconnect = this.options.autoreconnect === false ? false : true;\n\t\tthis.options.autoconnect = this.options.autoconnect === false ? false : true;\n\t\tthis.options.connectWait = 1;\n\n\t\tif(!this.options.url.startsWith('ws://') && !this.options.url.startsWith('wss://')) {\n\t\t\tif(document.location.protocol == 'https:') {\n\t\t\t\tthis.options.url = `wss://${document.location.hostname}` + this.options.url\n\t\t\t} else {\n\t\t\t\tthis.options.url = `ws://${document.location.hostname}:${document.location.port || '80'}` + this.options.url;\n\t\t\t}\n\t\t}\n\n\t\tif(this.options.autoconnect) {\n\t\t\tthis.initSocket();\n\t\t}\n\t}\n\n\tinitSocket() {\n\t\tthis.ws = new WebSocket(this.options.url);\n\t\tthis.ws.onclose = this.onClose.bind(this);\n\t\tthis.ws.onmessage = function (e) {\n\t\t\t// $FlowFixMe\n\t\t\tthis.onMessage(JSON.parse(e.data));\n\t\t}.bind(this);\n\n\t\tthis._whenConnected = new Promise((resolve, reject) => {\n\t\t\tthis.ws.onopen = () => {\n\t\t\t\tthis.onOpen();\n\t\t\t\tresolve(this);\n\t\t\t}\n\t\t});\n\t}\n\t\n\tonOpen() {\n\t\tthis.options.connectWait = 1.0;\n\t\tthis.options.onOpen(this, this.ws);\n\t}\n\t\n\tonClose() {\n\t\tthis.options.onClose(this, this.ws);\n\n\t\tif(this.options.autoreconnect === true) {\n\t\t\tsetTimeout(() => this.open(), this.options.connectWait * 1000);\n\t\t\tthis.options.connectWait *= 2;\n\t\t\tthis.options.connectWait = this.options.connectWait > 30 ? 30 : this.options.connectWait;\n\t\t}\n\t}\n\t\n\tonMessage(packet:Packet) {\n\t\tif(packet.e && typeof packet.e == 'string') {\n\t\t\tthis.stats.in++;\n\t\t\t(this.eventNameToFunction(packet.e))(packet.d);\n\n\t\t\tif(packet.id) {\n\t\t\t\tvar fn = this.callbackLookup.get(this.callbackKey(packet));\n\t\t\t\tif(fn) {\n\t\t\t\t\tfn(packet.d);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tcallbackKey(packet:Packet) {\n\t\tif(packet.e.endsWith(\":reply\")) {\n\t\t\treturn `${packet.e}:${(packet.id || 0).toString()}`;\n\t\t} else {\n\t\t\treturn `${packet.e}:reply:${(packet.id || 0).toString()}`;\n\t\t}\n\t}\n\n\tsend(eventType:string, data:Object={}) {\n\t\tif(this.isConnected()) {\n\t\t\tthis.packetId += 1;\n\t\t\tvar packet:Packet = {e: eventType, d: data || {}, id: this.packetId}\n\t\t\tthis.ws.send(JSON.stringify(packet));\n\t\t\tthis.stats.out++;\n\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tthis.callbackLookup.add(this.callbackKey(packet), resolve);\n\t\t\t});\n\t\t\t\n\t\t} else {\n\t\t\treturn Promise.reject('NOT_CONNECTED');\n\t\t}\n\t}\n\n\ton(eventType:string, fn:Function) {\n\t\treturn this.addEvent(eventType, fn);\n\t}\n\n\taddEvent(eventType:string, fn:Function) {\n\t\t\n\t\tif(eventType && typeof fn == 'function') {\n\t\t\tvar fnName = 'on_' + eventType.toLowerCase();\n\t\t\t\n\t\t\tif(!this.options[fnName]) {\n\t\t\t\tthis.options[fnName] = fn;\n\t\t\t} else if(typeof this.options[fnName] == 'function') {\n\t\t\t\tvar currentFn = this.options[fnName];\n\t\t\t\tthis.options[fnName] = function() {\n\t\t\t\t\tcurrentFn.apply(this, arguments);\n\t\t\t\t\tfn.apply(this, arguments);\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\treturn this;\n\t}\n\n\teventNameToFunction(eventType:string):Function {\n\t\tif(eventType) {\n\t\t\tvar fnName = 'on_' + eventType.toLowerCase();\n\t\t\treturn this.options[fnName] || (()=>{});\n\t\t} else {\n\t\t\treturn (()=>{});\n\t\t}\n\t}\n\n\tisConnected() {\n\t\tvar openState = WebSocket.OPEN || 1; // turns out not all browsers define the state consts\n\t\treturn this.ws && this.ws.readyState === openState;\n\t}\n\n\tclose() {\n\t\tthis.options.autoreconnect = false;\n\t\tthis.ws.close();\n\t}\n\n\topen() {\n\t\tthis.initSocket();\n\t}\n\n\twhenConnected() {\n\t\treturn this._whenConnected;\n\t}\n}\n\nclass TimedHash {\n\tlastPurge:number;\n\tdata:{};\n\toptions:{ maxAgeSec:number };\n\n\tconstructor(options:Object) {\n\t\tthis.options = options || {};\n\t\tthis.options.maxAgeSec = this.options.maxAgeSec || 30.0;\n\t\tthis.data = {};\n\t\tthis.lastPurge = Date.now();\n\t}\n\n\tadd(k:string, contents:Object) {\n\t\tif(this.lastPurge < Date.now() - 1000) {\n\t\t\tthis.purge();\n\t\t}\n\n\t\tthis.data[k] = { \n\t\t\tcontents:contents,\n\t\t\taddedAt: Date.now()\n\t\t};\n\t}\n\n\tget(k:string) {\n\t\treturn (this.data[k] || {}).contents;\n\t}\n\n\tcontains(k:string) {\n\t\treturn this.data[k] != null;\n\t}\n\n\tpurge() {\n\t\tthis.expiredKeys().forEach((k) => delete this.data[k]);\n\t\tthis.lastPurge = Date.now();\n\t}\n\n\tcount() {\n\t\treturn Object.keys(this.data).length\n\t}\n\n\texpiredKeys():string[] {\n\t\treturn Object.keys(this.data).filter((k) => {\n\t\t\treturn this.data[k].addedAt < Date.now() - this.options.maxAgeSec * 1000;\n\t\t});\n\t}\n}\n\n"]}