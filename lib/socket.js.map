{"version":3,"sources":["../src/socket.js"],"names":["JSONSocket","constructor","options","packetId","stats","in","out","callbackLookup","maxAgeSec","url","onOpen","onClose","autoreconnect","autoconnect","connectWait","startsWith","document","location","protocol","hostname","port","initSocket","ws","WebSocket","onclose","bind","onmessage","e","onMessage","JSON","parse","data","_whenConnected","Promise","resolve","reject","onopen","setTimeout","open","packet","eventNameToFunction","d","id","fn","get","callbackKey","endsWith","toString","send","eventType","isConnected","stringify","add","addEvent","fnName","toLowerCase","currentFn","apply","arguments","openState","OPEN","readyState","close","whenConnected","window"],"mappings":"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","file":"socket.js","sourcesContent":["// @flow\n\nimport TimedHash from './timed_hash'\n\ntype Packet = {\n\te:string,\n\td:Object,\n\tid?:number\n}\n\nexport class JSONSocket {\n\tws:WebSocket;\n\toptions:Object;\n\tpacketId:number;\n\tcallbackLookup:TimedHash;\n\tstats:{in:number,out:number};\n\t_whenConnected:Promise<*>;\t\n\tconstructor(options:Object) {\n\n\t\tthis.packetId = 1;\n\t\tthis.stats = { in: 0, out: 0 };\n\t\tthis.callbackLookup = new TimedHash({ maxAgeSec: 30.0 });\n\n\t\tthis.options = options || {};\n\t\tthis.options.url = this.options.url || '';\n\t\tthis.options.onOpen = this.options.onOpen || function() {};\n\t\tthis.options.onClose = this.options.onClose || function() {};\n\n\t\tthis.options.autoreconnect = this.options.autoreconnect === false ? false : true;\n\t\tthis.options.autoconnect = this.options.autoconnect === false ? false : true;\n\t\tthis.options.connectWait = 1;\n\n\t\tif(!this.options.url.startsWith('ws://') && !this.options.url.startsWith('wss://')) {\n\t\t\tif(document.location.protocol == 'https') {\n\t\t\t\tthis.options.url = `wss://${document.location.hostname}` + this.options.url\n\t\t\t} else {\n\t\t\t\tthis.options.url = `ws://${document.location.hostname}:${document.location.port || '80'}` + this.options.url;\n\t\t\t}\n\t\t}\n\n\t\tif(this.options.autoconnect) {\n\t\t\tthis.initSocket();\n\t\t}\n\t}\n\n\tinitSocket() {\n\t\tthis.ws = new WebSocket(this.options.url);\n\t\tthis.ws.onclose = this.onClose.bind(this);\n\t\tthis.ws.onmessage = function (e) {\n\t\t\t// $FlowFixMe\n\t\t\tthis.onMessage(JSON.parse(e.data));\n\t\t}.bind(this);\n\n\t\tthis._whenConnected = new Promise((resolve, reject) => {\n\t\t\tthis.ws.onopen = () => {\n\t\t\t\tthis.onOpen();\n\t\t\t\tresolve(this);\n\t\t\t}\n\t\t});\n\t}\n\t\n\tonOpen() {\n\t\tthis.options.connectWait = 1.0;\n\t\tthis.options.onOpen(this, this.ws);\n\t}\n\t\n\tonClose() {\n\t\tthis.options.onClose(this, this.ws);\n\n\t\tif(this.options.autoreconnect === true) {\n\t\t\tsetTimeout(() => this.open(), this.options.connectWait * 1000);\n\t\t\tthis.options.connectWait *= 2;\n\t\t\tthis.options.connectWait = this.options.connectWait > 30 ? 30 : this.options.connectWait;\n\t\t}\n\t}\n\t\n\tonMessage(packet:Packet) {\n\t\tif(packet.e && typeof packet.e == 'string') {\n\t\t\tthis.stats.in++;\n\t\t\t(this.eventNameToFunction(packet.e))(packet.d);\n\n\t\t\tif(packet.id) {\n\t\t\t\tvar fn = this.callbackLookup.get(this.callbackKey(packet));\n\t\t\t\tif(fn) {\n\t\t\t\t\tfn(packet.d);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tcallbackKey(packet:Packet) {\n\t\tif(packet.e.endsWith(\":reply\")) {\n\t\t\treturn `${packet.e}:${(packet.id || 0).toString()}`;\n\t\t} else {\n\t\t\treturn `${packet.e}:reply:${(packet.id || 0).toString()}`;\n\t\t}\n\t}\n\n\tsend(eventType:string, data:any) {\n\t\tif(this.isConnected()) {\n\t\t\tthis.packetId += 1;\n\t\t\tvar packet:Packet = {e: eventType, d: data, id: this.packetId}\n\t\t\tthis.ws.send(JSON.stringify(packet));\n\t\t\tthis.stats.out++;\n\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tthis.callbackLookup.add(this.callbackKey(packet), resolve);\n\t\t\t});\n\t\t\t\n\t\t} else {\n\t\t\treturn Promise.reject('NOT_CONNECTED');\n\t\t}\n\t}\n\n\taddEvent(eventType:string, fn:Function) {\n\t\t\n\t\tif(eventType && typeof fn == 'function') {\n\t\t\tvar fnName = 'on_' + eventType.toLowerCase();\n\t\t\t\n\t\t\tif(!this.options[fnName]) {\n\t\t\t\tthis.options[fnName] = fn;\n\t\t\t} else if(typeof this.options[fnName] == 'function') {\n\t\t\t\tvar currentFn = this.options[fnName];\n\t\t\t\tthis.options[fnName] = function() {\n\t\t\t\t\tcurrentFn.apply(this, arguments);\n\t\t\t\t\tfn.apply(this, arguments);\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\treturn this;\n\t}\n\n\teventNameToFunction(eventType:string):Function {\n\t\tif(eventType) {\n\t\t\tvar fnName = 'on_' + eventType.toLowerCase();\n\t\t\treturn this.options[fnName] || (()=>{});\n\t\t} else {\n\t\t\treturn (()=>{});\n\t\t}\n\t}\n\n\tisConnected() {\n\t\tvar openState = WebSocket.OPEN || 1; // turns out not all browsers define the state consts\n\t\treturn this.ws && this.ws.readyState === openState;\n\t}\n\n\tclose() {\n\t\tthis.options.autoreconnect = false;\n\t\tthis.ws.close();\n\t}\n\n\topen() {\n\t\tthis.initSocket();\n\t}\n\n\twhenConnected() {\n\t\treturn this._whenConnected;\n\t}\n}\n\n// global export...\nwindow.JSONSocket = window.JSONSocket  || JSONSocket;\n"]}